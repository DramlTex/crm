CHANGELOG.md merge=union
changelog/fragments/* merge=union
# Автоматически сливаем данные из файла-хранилища
# Обратите внимание: database.json не хранится в репозитории, но правило добавлено
# на случай, если он появится
database.json merge=union
# .github/workflows/auto-rebase.yml
name: Auto-rebase Codex PR

on:
  pull_request_target:          # контекст main → есть доступ к секретам
    types: [opened, synchronize, labeled]
    branches: [main]

jobs:
  rebase:
    # a) любой PR, у которого head-branch начинается с "codex/"
    # b) или у которого есть лейбл "codex"
    if: startsWith(github.head_ref, 'codex/') ||
        contains(join(github.event.pull_request.labels.*.name, ','), 'codex')

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CUSTOM_GH_TOKEN }}   # PAT или токен GitHub App
          fetch-depth: 0

      # <--------------------------------------------->
      # 2 - объявляем merge-драйвер прямо в раннере
      #    (так будет виден ребейзу cirrus-action)
      - name: Register merge drivers
        run: |
          git config --global merge.keep-bot.name "keep bot version"
          git config --global merge.keep-bot.driver "bash -c 'cp %B %A'"
          echo "README.md merge=union"          >> .gitattributes
          echo "index.html merge=keep-bot"      >> .gitattributes
          echo "assets/common.js merge=keep-bot" >> .gitattributes
          git add .gitattributes
          git commit -m "ci: register merge drivers" || true

      - name: Rebase onto main
        uses: cirrus-actions/rebase@v3
